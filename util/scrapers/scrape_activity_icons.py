#!/usr/bin/env python3
"""
Download activity icons from Walkscape wiki.

Scrapes the Activities wiki page and downloads SVG icons for each activity.
Uses the activities.py file to determine the correct primary skill category.

Icons are saved to: assets/icons/activities/{primary_skill}/{activity_name}.svg
"""

import requests
import sys
import os
from pathlib import Path
from bs4 import BeautifulSoup

# Add parent directory to path for imports
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.dirname(__file__))))

from util.scrapers.scraper_utils import download_page, get_cache_file, sanitize_filename
from util.autogenerated.activities import Activity

# ============================================================================
# CONFIGURATION
# ============================================================================

RESCRAPE = False
WIKI_URL = 'https://wiki.walkscape.app/wiki/Activities'
CACHE_FILE = get_cache_file('activities_cache.html')
BASE_OUTPUT_DIR = Path('assets/icons/activities')

# ============================================================================
# HELPER FUNCTIONS
# ============================================================================

def download_icon(url: str, output_path: Path) -> bool:
    """Download a single icon SVG file."""
    if not url:
        return False
    
    try:
        # Ensure URL is absolute
        if url.startswith('/'):
            url = 'https://wiki.walkscape.app' + url
        elif not url.startswith('http'):
            url = 'https://wiki.walkscape.app/' + url
        
        print(f"  Downloading: {url}")
        
        # Download the file
        response = requests.get(url, timeout=10)
        response.raise_for_status()
        
        # Create parent directory if needed
        output_path.parent.mkdir(parents=True, exist_ok=True)
        
        # Save to file
        with open(output_path, 'wb') as f:
            f.write(response.content)
        
        print(f"    ✓ Saved to {output_path}")
        return True
    except Exception as e:
        print(f"    ✗ Error: {e}")
        return False

def get_primary_skill_for_activity(activity_name: str) -> str:
    """Get primary skill from activities.py for an activity name."""
    # Build lookup dict from Activity enum
    activity_lookup = {}
    for attr_name in dir(Activity):
        if attr_name.startswith('_'):
            continue
        attr = getattr(Activity, attr_name)
        if hasattr(attr, 'name') and hasattr(attr, 'primary_skill'):
            activity_lookup[attr.name.lower()] = attr.primary_skill.lower() if attr.primary_skill else 'other'
    
    # Try to find matching activity
    activity_lower = activity_name.lower()
    if activity_lower in activity_lookup:
        return activity_lookup[activity_lower]
    
    # If not found, return 'other'
    print(f"  ⚠ Activity '{activity_name}' not found in activities.py, using 'other'")
    return 'other'

# ============================================================================
# SCRAPING FUNCTIONS
# ============================================================================

def scrape_activity_icons():
    """Scrape activity icons from wiki."""
    print("Downloading activity icons from wiki...")
    
    # Download wiki page
    html = download_page(WIKI_URL, CACHE_FILE, rescrape=RESCRAPE)
    if not html:
        print("✗ Failed to download wiki page")
        return []
    
    soup = BeautifulSoup(html, 'html.parser')
    
    # Find all wikitable tables
    tables = soup.find_all('table', class_='wikitable')
    print(f"Found {len(tables)} wikitable tables")
    
    # Debug: print info about each table
    for i, table in enumerate(tables):
        rows = table.find_all('tr')
        print(f"Table {i}: {len(rows)} rows")
        if len(rows) > 0:
            first_row = rows[0]
            cells = first_row.find_all(['th', 'td'])
            print(f"  First row has {len(cells)} cells")
    
    if len(tables) < 1:
        print("✗ Could not find activities table")
        return []
    
    # The table with ~99 rows is the activities table
    activities_table = None
    for table in tables:
        rows = table.find_all('tr')
        if len(rows) > 50:  # Activities table has many rows
            activities_table = table
            break
    
    if not activities_table:
        print("✗ Could not find activities table with many rows")
        return []
    
    print(f"Using activities table with {len(activities_table.find_all('tr'))} rows\n")
    
    activities = []
    
    # Parse table rows
    rows = activities_table.find_all('tr')
    
    for row in rows:
        # Skip header rows
        if row.find('th'):
            continue
        
        # Get all cells in the row
        cells = row.find_all('td')
        if len(cells) < 2:
            continue
        
        # First cell contains the icon
        icon_cell = cells[0]
        img = icon_cell.find('img')
        
        if not img:
            continue
        
        # Get icon URL
        icon_src = img.get('src', '')
        if not icon_src or not icon_src.endswith('.svg'):
            continue
        
        # Second cell contains the activity name
        name_cell = cells[1]
        activity_name = name_cell.get_text(strip=True)
        
        if not activity_name:
            continue
        
        # Get primary skill from activities.py
        primary_skill = get_primary_skill_for_activity(activity_name)
        
        activities.append({
            'name': activity_name,
            'primary_skill': primary_skill,
            'icon_url': icon_src
        })
        
        print(f"  Found: {primary_skill}/{activity_name}")
    
    if not activities:
        print("\n✗ No activity icons found")
    
    return activities

# ============================================================================
# ENTRY POINT
# ============================================================================

if __name__ == '__main__':
    print("=== Activity Icon Scraper ===\n")
    
    activities = scrape_activity_icons()
    
    if activities:
        print(f"\n✓ Found {len(activities)} activity icons")
        print("\nDownloading icons...\n")
        
        success_count = 0
        for activity in activities:
            primary_skill = activity['primary_skill']
            name = activity['name']
            icon_url = activity['icon_url']
            
            # Create safe filename
            safe_name = sanitize_filename(name.lower().replace(' ', '_'))
            filename = f"{safe_name}.svg"
            
            # Create category directory path
            output_path = BASE_OUTPUT_DIR / primary_skill / filename
            
            print(f"{primary_skill}/{name}")
            if download_icon(icon_url, output_path):
                success_count += 1
        
        print(f"\n✓ Downloaded {success_count}/{len(activities)} icons")
        print(f"✓ Icons saved to {BASE_OUTPUT_DIR}/")
    else:
        print("\n✗ No icons to download")
